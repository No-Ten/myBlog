

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/myBlog/img/favicon.png">
  <link rel="icon" href="/myBlog/img/browserTitle.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Redis笔记Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，Redis的开发工作由VMware主持。">
  <meta name="author" content="Ten">
  <meta name="keywords" content="">
  <meta name="description" content="Redis笔记Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，Redis的开发工作由VMware主持。">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://no-ten.github.io/Redis/index.html">
<meta property="og:site_name" content="TBlog">
<meta property="og:description" content="Redis笔记Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，Redis的开发工作由VMware主持。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211105143145272-1636731322211.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211105143507833-1636731322212.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211105144556574-1636731322212.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211105151219429-1636731322212.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211105214415132-1636731341803.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211106002032827-1636731341803.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211106150331202-1636731341803.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211107113912628-1636731341803.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211109161652248-1636731414340.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211109193951137-1636731414341.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211109194709896-1636731414341.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110111343837-1636731446157.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110115128561-1636731446157.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110125255401-1636731446158.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110125322034-1636731446158.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110122837901-1636731446158.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110123055770-1636731446158.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110141642042-1636731446158.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110142031866-1636731446158.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110142125541-1636731446169.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110142435094-1636731446169.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110160627503-1636731465018.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110164938440-1636731465018.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110193759690-1636731465019.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110200036007-1636731465018.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110202645563-1636731465019.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110204544847-1636731465019.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110212837552-1636731483147.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110214237579-1636731483147.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110214533317-1636731483148.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110220805289-1636731483148.png">
<meta property="og:image" content="https://no-ten.github.io/myBlog/Redis/image-20211110221746510-1636731483148.png">
<meta property="article:published_time" content="2021-11-12T15:26:58.000Z">
<meta property="article:modified_time" content="2021-11-12T15:42:30.811Z">
<meta property="article:author" content="Ten">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="NoSQL">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://no-ten.github.io/myBlog/Redis/image-20211105143145272-1636731322211.png">
  
  <title>Redis - TBlog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/myBlog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/myBlog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"no-ten.github.io","root":"/myBlog/","version":"1.8.12","typing":{"enable":true,"typeSpeed":230,"cursorChar":"_","loop":true},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/myBlog/local-search.xml"};
  </script>
  <script  src="/myBlog/js/utils.js" ></script>
  <script  src="/myBlog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/myBlog/atom.xml" title="TBlog" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/myBlog/">
      <strong>TBlog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/myBlog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/myBlog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/myBlog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/myBlog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/myBlog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/myBlog/img/articleImages/redisIndex.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Redis">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Ten
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-12 23:26" pubdate>
        2021年11月12日晚上11点26分 
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      43k 字
    </span>
  

  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Redis</h1>
            
            <div class="markdown-body">
              <h1 id="Redis笔记"><a href="#Redis笔记" class="headerlink" title="Redis笔记"></a>Redis笔记</h1><p>Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，Redis的开发工作由VMware主持。</p>
<span id="more"></span>

<p>官网：<a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io/</a></p>
<p>中文网：<a target="_blank" rel="noopener" href="http://www.redis.cn/">http://www.redis.cn/</a></p>
<h1 id="Nosql概述"><a href="#Nosql概述" class="headerlink" title="Nosql概述"></a>Nosql概述</h1><h2 id="为什么用Nosql"><a href="#为什么用Nosql" class="headerlink" title="为什么用Nosql"></a>为什么用Nosql</h2><ol>
<li><p>单击MySQL的年代</p>
<ul>
<li><p>数据量如果太大，一个机器内存放不了</p>
</li>
<li><p>数据的索引（B+Tree），一个机器内存也放不下</p>
</li>
<li><p>访问量（读写混合），一个服务器承受不来</p>
</li>
</ul>
<p><img src="/myBlog/Redis/image-20211105143145272-1636731322211.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211105143145272"></p>
</li>
<li><p>memcached（缓存）+MySQL+垂直拆分（读写分离）</p>
<ul>
<li>发展过程：优化数据结构和索引–&gt;文件缓存（IO）–&gt; Memcached（当时最热门的技术）</li>
</ul>
<p><img src="/myBlog/Redis/image-20211105143507833-1636731322212.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211105143507833"></p>
</li>
<li><p>分库分表+水平拆分+mysql集群</p>
<ul>
<li>==本质：数据库（读、写）==</li>
</ul>
<p><img src="/myBlog/Redis/image-20211105144556574-1636731322212.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211105144556574"></p>
</li>
<li><p>如今</p>
<p><img src="/myBlog/Redis/image-20211105151219429-1636731322212.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211105151219429"></p>
</li>
<li><p>为什么用Nosql</p>
<p>用户的个人信息，社交网络，地理位置。用户自己产生的数据，用户日志等等爆发式的增长</p>
</li>
</ol>
<h2 id="什么是NoSQL"><a href="#什么是NoSQL" class="headerlink" title="什么是NoSQL"></a>什么是NoSQL</h2><p>NoSQL = Not Only SQL</p>
<p>泛指非关系型数据库，传统的关系型数据库难以对付web2.0时代！，NoSQL在当今大数据时代环境下迅速发展，Redis。</p>
<p>关系型数据库：表格，行，列</p>
<h2 id="NoSQL特点"><a href="#NoSQL特点" class="headerlink" title="NoSQL特点"></a>NoSQL特点</h2><ol>
<li><p>方便扩展（数据之间没有关系，很好扩展）</p>
</li>
<li><p>大数据量高性能（Redis一秒抄写8万次，读取11万，Nosql的缓存记录集，是一种细粒度的缓存，性能较高）</p>
</li>
<li><p>数据类型，多样性 </p>
</li>
<li><p>传统的RDBMS和Nosql</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">传统的RDBMS<br><span class="hljs-bullet">- </span>结构化组织<br><span class="hljs-bullet">- </span>SQL<br><span class="hljs-bullet">- </span>数据和关系都存在单独的表中<br><span class="hljs-bullet">- </span>操作，数据定义语言<br><span class="hljs-bullet">- </span>严格的一致性<br><span class="hljs-bullet">- </span>基础的事务<br></code></pre></td></tr></table></figure>

<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Nosql<br><span class="hljs-bullet">- </span>不仅仅是数据<br><span class="hljs-bullet">- </span>没有固定的查询语言<br><span class="hljs-bullet">- </span>键值对存储，列存储，文档存储，图形数据库（社交关系）<br><span class="hljs-bullet">- </span>最终一致性<br><span class="hljs-bullet">- </span>CAP定理和BASE(异地多活)<br><span class="hljs-bullet">- </span>高性能，高可用，高并发<br></code></pre></td></tr></table></figure></li>
</ol>
<p>了解：3v+3高</p>
<p><strong>3v：</strong></p>
<ol>
<li>海量volume</li>
<li>多样variety</li>
<li>实时velocity</li>
</ol>
<p><strong>3高：</strong></p>
<ol>
<li>高并发</li>
<li>高可用(或者高可扩，随时水平拆分，机器不够了，可用扩展机器)</li>
<li>高性能</li>
</ol>
<h2 id="NoSQL的四大分类"><a href="#NoSQL的四大分类" class="headerlink" title="NoSQL的四大分类"></a>NoSQL的四大分类</h2><p><strong>KV键值对：</strong></p>
<ul>
<li>redis</li>
</ul>
<p><strong>文档类型数据库(bson格式和json一样)：</strong></p>
<ul>
<li>MongoDB（一般必须掌握）<ul>
<li>MongoDB是一个基于分布式文件存储的数据库，主要用来处理大量的文档</li>
<li>MongoDB是一个介于关系型数据库和非关系型数据中间的产品 ，MongoDB是非关系型数据库中功能最丰富，最像关系型数据库的</li>
</ul>
</li>
</ul>
<p><strong>列存储数据库</strong></p>
<ul>
<li>HBase</li>
<li>分布式文件系统</li>
</ul>
<p><strong>图关系数据库</strong></p>
<ul>
<li>存关系，比如朋友圈社交网络，广告推荐</li>
<li>Neo4j， InfoGrid</li>
</ul>
<h1 id="Redis入门"><a href="#Redis入门" class="headerlink" title="Redis入门"></a>Redis入门</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Redis （Remote Dictionnary Server）,即远程字典服务。 是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。</p>
<h2 id="Redis能干嘛"><a href="#Redis能干嘛" class="headerlink" title="Redis能干嘛"></a>Redis能干嘛</h2><ol>
<li>内存存储、持久化，内存中是断点即失，所以说持久化很重要（rdb，aof）</li>
<li>效率高，可以用于高速缓存</li>
<li>发布订阅系统</li>
<li>地图信息分析</li>
<li>计时器、计数器（浏览量） </li>
<li>….</li>
</ol>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ol>
<li>多样的数据类型</li>
<li>持久化</li>
<li>集群</li>
<li>事务</li>
<li>…</li>
</ol>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>wsl（Windows下的Linux子系统）</p>
<h3 id="Windows安装"><a href="#Windows安装" class="headerlink" title="Windows安装"></a><strong>Windows安装</strong></h3><h3 id="Linux安装"><a href="#Linux安装" class="headerlink" title="Linux安装"></a><strong>Linux安装</strong></h3><ol>
<li><p>下载安装包</p>
</li>
<li><p>解压到/opt目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost opt]<span class="hljs-comment"># ls </span><br>redis-6.2.6  redis-6.2.6.tar.gz<br>[root@localhost opt]<span class="hljs-comment"># </span><br><br></code></pre></td></tr></table></figure></li>
<li><p>进到redis目录下，下载yum</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install gcc-c++<br></code></pre></td></tr></table></figure>

<p>结果报了以下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost redis-6.2.6]<span class="hljs-comment"># yum install gcc-c++</span><br>Loaded plugins: fastestmirror, langpacks<br>Loading mirror speeds from cached hostfile<br>Could not retrieve mirrorlist http://mirrorlist.centos.org/?release=7&amp;arch=x86_64&amp;repo=os&amp;infra=stock error was<br>14: curl<span class="hljs-comment">#6 - &quot;Could not resolve host: mirrorlist.centos.org; Unknown error&quot;</span><br><br><br> One of the configured repositories failed (Unknown),<br> and yum doesn<span class="hljs-string">&#x27;t have enough cached data to continue. At this point the only</span><br><span class="hljs-string"> safe thing yum can do is fail. There are a few ways to work &quot;fix&quot; this:</span><br><span class="hljs-string"></span><br><span class="hljs-string">     1. Contact the upstream for the repository and get them to fix the problem.</span><br><span class="hljs-string"></span><br><span class="hljs-string">     2. Reconfigure the baseurl/etc. for the repository, to point to a working</span><br><span class="hljs-string">        upstream. This is most often useful if you are using a newer</span><br><span class="hljs-string">        distribution release than is supported by the repository (and the</span><br><span class="hljs-string">        packages for the previous distribution release still work).</span><br><span class="hljs-string"></span><br><span class="hljs-string">     3. Run the command with the repository temporarily disabled</span><br><span class="hljs-string">            yum --disablerepo=&lt;repoid&gt; ...</span><br><span class="hljs-string"></span><br><span class="hljs-string">     4. Disable the repository permanently, so yum won&#x27;</span>t use it by default. Yum<br>        will <span class="hljs-keyword">then</span> just ignore the repository until you permanently <span class="hljs-built_in">enable</span> it<br>        again or use --enablerepo <span class="hljs-keyword">for</span> temporary usage:<br><br>            yum-config-manager --<span class="hljs-built_in">disable</span> &lt;repoid&gt;<br>        or<br>            subscription-manager repos --<span class="hljs-built_in">disable</span>=&lt;repoid&gt;<br><br>     5. Configure the failing repository to be skipped, <span class="hljs-keyword">if</span> it is unavailable.<br>        Note that yum will try to contact the repo. when it runs most commands,<br>        so will have to try and fail each time (and thus. yum will be be much<br>        slower). If it is a very temporary problem though, this is often a nice<br>        compromise:<br><br>            yum-config-manager --save --<span class="hljs-built_in">setopt</span>=&lt;repoid&gt;.skip_if_unavailable=<span class="hljs-literal">true</span><br><br>Cannot find a valid baseurl <span class="hljs-keyword">for</span> repo: base/7/x86_64<br><br></code></pre></td></tr></table></figure>

<p>解决方案：</p>
<ul>
<li>检查网络，发现ping不通，网络有问题</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[admin@localhost ~]$ ping baidu.com<br>ping: baidu.com: Name or service not known<br>[admin@localhost ~]$ <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">BOOTPROTO=static<br>DEFROUTE=yes<br>IPADDR=192.168.242.3<br>NETMSAK=255.255.255.0<br>GATEWAY=192.168.242.2<br>ONBOOT=yes<br>DNS1=192.168.242.2				<span class="hljs-comment"># 原来是之前配置网络的时候，这一行忘记配置了</span><br><br></code></pre></td></tr></table></figure>

<ul>
<li>配置好，重启服务器，即可</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">service network restart<br></code></pre></td></tr></table></figure>

<ul>
<li><p>重新执行安装yum的命令。建议使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y gcc-c++		<span class="hljs-comment"># -y表示出现的询问都同意</span><br></code></pre></td></tr></table></figure></li>
</ul>
<p>检查是否安装成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -v<br></code></pre></td></tr></table></figure></li>
<li><p>在redis的目录下执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">make<br>make install<br></code></pre></td></tr></table></figure></li>
<li><p>redis安装默认路径<code>/usr/local/bin</code></p>
</li>
<li><p>拷贝/opt下面的redis的中的conf文件到/usr/local/bin/myredisconfig文件夹下面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cp /opt/redis-6.2.6/redis.conf ./myredisconfig<br></code></pre></td></tr></table></figure></li>
<li><p>redis默认不是后台运行，键daemonize处的no改为yes</p>
<p><img src="/myBlog/Redis/image-20211105214415132-1636731341803.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211105214415132"></p>
</li>
<li><p>设置密码，找到# requirepass foobared，另起一行（除了设置这些之外，还可以设置redis开机自启等等，具体可以网上搜索）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">requirepass xxx			<span class="hljs-comment"># xxx是你的密码</span><br></code></pre></td></tr></table></figure></li>
<li><p>启动redis，但是没有信息出来，所以使用 <code>ps -ef |gref redis</code>查看6379端口号是否在使用，接着启动客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost bin]<span class="hljs-comment"># pwd</span><br>/usr/<span class="hljs-built_in">local</span>/bin<br>[root@localhost bin]<span class="hljs-comment"># ./redis-server myredisconfig/redis.conf </span><br>[root@localhost bin]<span class="hljs-comment"># ps -ef |grep redis</span><br>root      10525      1  0 21:53 ?        00:00:00 ./redis-server 127.0.0.1:6379<br>root      10539   3057  0 21:54 pts/0    00:00:00 grep --color=auto redis<br>[root@localhost bin]<span class="hljs-comment"># </span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost bin]<span class="hljs-comment"># ./redis-cli -p 6379</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure></li>
<li><p>测试，发现值存不进去</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> name Ten<br>(error) NOAUTH Authentication required.<br></code></pre></td></tr></table></figure>

<p>经过查找，原来是上一步我们设置了密码，需要认证，输入密码就可以了<code>auth &quot;xxx&quot;</code>，xxx是你的密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; auth xxx<br>OK<br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure></li>
<li><p>关闭redis服务<code>shutdown</code>，再次使用ps -ef |grep redis 查看，redis进程已经被关闭</p>
</li>
</ol>
<h2 id="测试性能"><a href="#测试性能" class="headerlink" title="测试性能"></a>测试性能</h2><p><strong>redis-benchmark</strong>：是一个官方自带的压力测试工具！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 测试：100个并发连接 100000请求</span><br>redis-benchmark -h localhost -p 6379 -c 100 -n 100000 <br></code></pre></td></tr></table></figure>

<p>如果redis设置了密码认证，可以先去redis.conf将密码暂时去掉</p>
<p>来自菜鸟教程的表格</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">序号</td>
<td align="left">选项</td>
<td align="left">描述</td>
<td align="left">默认值</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left"><strong>-h</strong></td>
<td align="left">指定服务器主机名</td>
<td align="left">127.0.0.1</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><strong>-p</strong></td>
<td align="left">指定服务器端口</td>
<td align="left">6379</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><strong>-s</strong></td>
<td align="left">指定服务器 socket</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">4</td>
<td align="left"><strong>-c</strong></td>
<td align="left">指定并发连接数</td>
<td align="left">50</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left"><strong>-n</strong></td>
<td align="left">指定请求数</td>
<td align="left">10000</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left"><strong>-d</strong></td>
<td align="left">以字节的形式指定 SET/GET 值的数据大小</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left"><strong>-k</strong></td>
<td align="left">1=keep alive 0=reconnect</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left"><strong>-r</strong></td>
<td align="left">SET/GET/INCR 使用随机 key, SADD 使用随机值</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">9</td>
<td align="left"><strong>-P</strong></td>
<td align="left">通过管道传输 <numreq> 请求</numreq></td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left"><strong>-q</strong></td>
<td align="left">强制退出 redis。仅显示 query/sec 值</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">11</td>
<td align="left"><strong>–csv</strong></td>
<td align="left">以 CSV 格式输出</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">12</td>
<td align="left">***-l*（L 的小写字母）**</td>
<td align="left">生成循环，永久执行测试</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">13</td>
<td align="left"><strong>-t</strong></td>
<td align="left">仅运行以逗号分隔的测试命令列表。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">14</td>
<td align="left">***-I*（i 的大写字母）**</td>
<td align="left">Idle 模式。仅打开 N 个 idle 连接并等待。</td>
<td align="left"></td>
</tr>
</tbody></table>
<p><img src="/myBlog/Redis/image-20211106002032827-1636731341803.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211106002032827"></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>redis默认有16个数据库</p>
<p><img src="/myBlog/Redis/image-20211106150331202-1636731341803.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211106150331202"></p>
<p>默认使用第0个</p>
<p>可以使用<code>select 2</code>切换第2个数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">select 2	<span class="hljs-comment"># 切换到2号数据库</span><br>dbsize		<span class="hljs-comment"># 查看当前数据库的大小</span><br>keys *		<span class="hljs-comment"># 查询所有的key</span><br>flushdb		<span class="hljs-comment"># 清除当前的数据库</span><br>flushall	<span class="hljs-comment"># 清空所有的数据库</span><br></code></pre></td></tr></table></figure>



<p><strong>redis是单线程</strong>（redis6.0之后是多线程）</p>
<p><strong>redis为什么单线程还这么快？</strong></p>
<p>误区1：高性能的服务器一定是多线程的？</p>
<p>误区2：多线程（CPU上下文会切换）一定比单线程效率高</p>
<p>核心：redis是将所有的数据全部放在内存中的，所以说使用单线程去操作效率是最高的，多线程（CPU上下文会切换：耗时的操作），对于内存系统来说，如果没有上下文切换效率就是最高的。多次读写都是在一个CPU上的，在内存情况下，这个就是最佳方案！</p>
<h1 id="五大数据类型"><a href="#五大数据类型" class="headerlink" title="五大数据类型"></a>五大数据类型</h1><h2 id="Redis-Key"><a href="#Redis-Key" class="headerlink" title="Redis-Key"></a>Redis-Key</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">exists name			<span class="hljs-comment"># 判断是否存在name</span><br>move name 1			<span class="hljs-comment"># 移动当前的数据库的name到1号数据库</span><br>del name			<span class="hljs-comment"># 删除name</span><br>expire name 10  	<span class="hljs-comment"># 设置name 10秒后过期 </span><br>ttl name			<span class="hljs-comment"># 查看剩余时间</span><br><span class="hljs-built_in">type</span> name			<span class="hljs-comment"># 查看当前的name的类型 </span><br></code></pre></td></tr></table></figure>



<h2 id="String（字符串）"><a href="#String（字符串）" class="headerlink" title="String（字符串）"></a>String（字符串）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">append key1 <span class="hljs-string">&quot;hello&quot;</span>			<span class="hljs-comment"># 在key1后面追加“hello”，如果当前key1不存在，则新建</span><br>strlen key1					<span class="hljs-comment"># 获取当前key1的字符长度</span><br></code></pre></td></tr></table></figure>



<p><strong>incr自增，计数器</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> views 0			<span class="hljs-comment"># 设置一个值为0的views</span><br>OK<br>127.0.0.1:6379&gt; get views<br><span class="hljs-string">&quot;0&quot;</span><br>127.0.0.1:6379&gt; INCR views			<span class="hljs-comment"># 将views的值加一</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; get views<br><span class="hljs-string">&quot;1&quot;</span><br>127.0.0.1:6379&gt; <br><br></code></pre></td></tr></table></figure>



<p><strong>decr自减</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; get views<br><span class="hljs-string">&quot;2&quot;</span><br>127.0.0.1:6379&gt; DECR views			<span class="hljs-comment"># 将views减一</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; get views<br><span class="hljs-string">&quot;1&quot;</span><br>127.0.0.1:6379&gt; <br><br></code></pre></td></tr></table></figure>



<p><strong>INCRBY views 10</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; get views<span class="hljs-string">&quot;1&quot;</span>127.0.0.1:6379&gt; INCRBY views 10		<span class="hljs-comment"># 一次性加10(integer) 11127.0.0.1:6379&gt; </span><br></code></pre></td></tr></table></figure>



<p><strong>DECRBY views 5</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; INCRBY views 10<br>(<span class="hljs-built_in">integer</span>) 11<br>127.0.0.1:6379&gt; DECRBY views 5		<span class="hljs-comment"># 一次性减5</span><br>(<span class="hljs-built_in">integer</span>) 6<br>127.0.0.1:6379&gt; <br><br></code></pre></td></tr></table></figure>



<p><strong>getrange</strong>:取一个字符串范围，取全部为0 -1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key1 <span class="hljs-string">&quot;hello,Ten&quot;</span><br>OK<br>127.0.0.1:6379&gt; GETRANGE key1 1 3<br><span class="hljs-string">&quot;ell&quot;</span><br>127.0.0.1:6379&gt; GETRANGE key1 0 3<br><span class="hljs-string">&quot;hell&quot;</span><br>127.0.0.1:6379&gt; GETRANGE key1 0 -1<br><span class="hljs-string">&quot;hello,Ten&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>setrange</strong>:替换某范围的字符串 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> key2 abcdefg<br>OK<br>127.0.0.1:6379&gt; get key2<br><span class="hljs-string">&quot;abcdefg&quot;</span><br>127.0.0.1:6379&gt; SETRANGE key2 1 xx<br>(<span class="hljs-built_in">integer</span>) 7<br>127.0.0.1:6379&gt; get key2<br><span class="hljs-string">&quot;axxdefg&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p>**setex:**设置过期时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; setex key3 30 <span class="hljs-string">&quot;hello&quot;</span>OK127.0.0.1:6379&gt; ttl key3(<span class="hljs-built_in">integer</span>) 21<br></code></pre></td></tr></table></figure>



<p><strong>setnx</strong>：不存在再设置，如果存在则不设置（在分布式锁中会常用到）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; setnx mykey <span class="hljs-string">&quot;redis&quot;</span>(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; get mykey<span class="hljs-string">&quot;redis&quot;</span>127.0.0.1:6379&gt; setnx mykey <span class="hljs-string">&quot;Mongodb&quot;</span>(<span class="hljs-built_in">integer</span>) 0127.0.0.1:6379&gt; get mykey<span class="hljs-string">&quot;redis&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>mset，mget，批量存值和取值</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3OK127.0.0.1:6379&gt; keys *1) <span class="hljs-string">&quot;k2&quot;</span>2) <span class="hljs-string">&quot;k3&quot;</span>3) <span class="hljs-string">&quot;k1&quot;</span>127.0.0.1:6379&gt; mget k1 k2 k31) <span class="hljs-string">&quot;v1&quot;</span>2) <span class="hljs-string">&quot;v2&quot;</span>3) <span class="hljs-string">&quot;v3&quot;</span>127.0.0.1:6379&gt; keys *1) <span class="hljs-string">&quot;k2&quot;</span>2) <span class="hljs-string">&quot;k3&quot;</span>3) <span class="hljs-string">&quot;k1&quot;</span>127.0.0.1:6379&gt; msetnx k1 v1 k4 v4			<span class="hljs-comment"># msetnx是原子性操作，要不成功，要不失败(integer) 0127.0.0.1:6379&gt; </span><br></code></pre></td></tr></table></figure>



<p><strong>key的巧妙设置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># set user:1 &#123;name:zhangsan,age:2&#125;	# 设置一个user:1 对象，值为json字符来保存一个对象# 这里的key是以巧妙的设计： user:&#123;id&#125;:&#123;filed&#125;127.0.0.1:6379&gt; mset user:1:name zhangsan user:1:age 2OK127.0.0.1:6379&gt; mget user:1:name user:1:age1) &quot;zhangsan&quot;2) &quot;2&quot;127.0.0.1:6379&gt; </span><br></code></pre></td></tr></table></figure>



<p><strong>getset</strong>，先get，再set，如果不存在值，则返回null，再设置新的值进入。如果存在先取出，再设置进去。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; getset db redis(nil)127.0.0.1:6379&gt; get db<span class="hljs-string">&quot;redis&quot;</span>127.0.0.1:6379&gt; getset db mongodb<span class="hljs-string">&quot;redis&quot;</span>127.0.0.1:6379&gt; get db<span class="hljs-string">&quot;mongodb&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>String类似的使用场景：value除了我们的字符串还可以是数字。</p>
<ul>
<li>计数器</li>
<li>统计多单位的数量</li>
<li>粉丝数</li>
<li>对象缓存存储</li>
</ul>
<h2 id="List-列表"><a href="#List-列表" class="headerlink" title="List(列表)"></a>List(列表)</h2><p>在redis里面，我们可以把list玩成，栈、队列、阻塞队列。</p>
<p><strong>lpush list one</strong>：往list中存入一个one的值（头部）</p>
<p><strong>lrange list 0 -1</strong>：取出list中所有的值</p>
<p> <strong>RPUSH list right</strong>：在右边加入right的值（尾部）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; lpush list one(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; lpush list two(<span class="hljs-built_in">integer</span>) 2127.0.0.1:6379&gt; keys *1) <span class="hljs-string">&quot;list&quot;</span>127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;two&quot;</span>2) <span class="hljs-string">&quot;one&quot;</span>127.0.0.1:6379&gt; RPUSH list right(<span class="hljs-built_in">integer</span>) 3127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;two&quot;</span>2) <span class="hljs-string">&quot;one&quot;</span>3) <span class="hljs-string">&quot;right&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><img src="/myBlog/Redis/image-20211107113912628-1636731341803.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211107113912628"></p>
<p><strong>lpop</strong>：从左边移除</p>
<p><strong>rpop</strong>：从右边移除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;two&quot;</span>2) <span class="hljs-string">&quot;one&quot;</span>3) <span class="hljs-string">&quot;right&quot;</span>127.0.0.1:6379&gt; LPOP list<span class="hljs-string">&quot;two&quot;</span>127.0.0.1:6379&gt; RPOP list<span class="hljs-string">&quot;right&quot;</span>127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;one&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>lindex list 0</strong> ：获取list索引为0的元素</p>
<p><strong>llen list</strong> ：查看当前list的长度 </p>
<p><strong>lrem list 2 one</strong>：移除list中的两个one（list中的值可以重复，如果超过最大数量，只移除存在的最大数量）</p>
<p><strong>ltrim mylist 1 2</strong>：截取mylist中的索引为1 和2的值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;1&quot;</span>2) <span class="hljs-string">&quot;2&quot;</span>3) <span class="hljs-string">&quot;3&quot;</span>127.0.0.1:6379&gt; LTRIM list 0 1OK127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;1&quot;</span>2) <span class="hljs-string">&quot;2&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>rpoplpush list otherlist</strong>：移除list中最后一个元素，并加到otherlist中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;1&quot;</span>2) <span class="hljs-string">&quot;2&quot;</span>3) <span class="hljs-string">&quot;3&quot;</span>127.0.0.1:6379&gt; rpoplpush list otherlist<span class="hljs-string">&quot;3&quot;</span>127.0.0.1:6379&gt; LRANGE list 0 -11) <span class="hljs-string">&quot;1&quot;</span>2) <span class="hljs-string">&quot;2&quot;</span>127.0.0.1:6379&gt; LRANGE otherlist 0 -11) <span class="hljs-string">&quot;3&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>lset list 0 item：</strong>将list中索引为0的值改成item（前提是，list中相对应的索引存在）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; lpush list 0				<span class="hljs-comment"># 插入元素(integer) 1127.0.0.1:6379&gt; LRANGE list 0 0				# 查看是否存在相对应的元素1) &quot;0&quot;127.0.0.1:6379&gt; lset list 0 itemOK127.0.0.1:6379&gt; LRANGE list 0 01) &quot;item&quot;127.0.0.1:6379&gt; lset list 1 other			# 索引为1的元素不存在，所以报错(error) ERR index out of range127.0.0.1:6379&gt; </span><br></code></pre></td></tr></table></figure>



<p>**linsert list before|after “world” “my”**：在list中的world之前（之后）加上my</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; clear127.0.0.1:6379&gt; rpush list <span class="hljs-string">&quot;hello&quot;</span>(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; rpush list <span class="hljs-string">&quot;world&quot;</span>(<span class="hljs-built_in">integer</span>) 2127.0.0.1:6379&gt; LINSERT list before <span class="hljs-string">&quot;world&quot;</span> <span class="hljs-string">&quot;my&quot;</span>		<span class="hljs-comment"># 在list中的world之前插入my(integer) 3127.0.0.1:6379&gt; LRANGE list 0 -11) &quot;hello&quot;2) &quot;my&quot;3) &quot;world&quot;127.0.0.1:6379&gt; </span><br></code></pre></td></tr></table></figure>



<h2 id="Set（集合）"><a href="#Set（集合）" class="headerlink" title="Set（集合）"></a>Set（集合）</h2><p>set中的值是不可以重复的，无序的</p>
<p>**sadd myset “hello”**：往myset中添加一个字符串hello</p>
<p><strong>smembers myset：</strong>取出myset中的值</p>
<p><strong>sismembers myset hello：</strong>判断myset里面是否有这个hello，如果有返回1，没有返回0</p>
<p><strong>scard myset</strong>：获取myset中的个数</p>
<p><strong>srem myset hello：</strong>移除myset中的hello元素</p>
<p><strong>srandmember myset 2：</strong>在myset中随机抽取两个数字，不要数字就是默认取一个</p>
<p><strong>spop myset：</strong>随机弹出myset中的一个元素</p>
<p><strong>smove myset myset2 holle：</strong>将myset中的hello元素移动到myset2中</p>
<p><strong>sdiff key1 key2：</strong>key1集合减去key2集合（==差集==）</p>
<p><strong>sinter key1 key2:</strong> key1和key2的==交集==</p>
<p><strong>sunion key1 key2</strong>：key1和key2的==并集==</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; sadd key1 1<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; sadd key1 2<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; sadd key1 3<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; sadd key2 3<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; sadd key2 4<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; sadd key2 5<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; SDIFF key1 key2			<span class="hljs-comment"># 差集</span><br>1) <span class="hljs-string">&quot;1&quot;</span><br>2) <span class="hljs-string">&quot;2&quot;</span><br>127.0.0.1:6379&gt; SINTER key1 key2		<span class="hljs-comment"># 交集（共同好友）</span><br>1) <span class="hljs-string">&quot;3&quot;</span><br>127.0.0.1:6379&gt; SUNION key1 key2		<span class="hljs-comment"># 并集</span><br>1) <span class="hljs-string">&quot;1&quot;</span><br>2) <span class="hljs-string">&quot;2&quot;</span><br>3) <span class="hljs-string">&quot;3&quot;</span><br>4) <span class="hljs-string">&quot;4&quot;</span><br>5) <span class="hljs-string">&quot;5&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>微博，A用户将所有关注的人放在一个set集合中，将它的粉丝也放在一个集合中</p>
<p>共同关注，共同爱好，推荐好友</p>
<h2 id="Hash（哈希）"><a href="#Hash（哈希）" class="headerlink" title="Hash（哈希）"></a>Hash（哈希）</h2><p>Map集合，key-Map集合，key-<key-value></key-value></p>
<p>hset myhash field1 hello:</p>
<p>hget</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hset myhash field1 hello<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; hget myhash field1<br><span class="hljs-string">&quot;hello&quot;</span><br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<p><strong>hmset</strong>:一次存多个值，如果重复会自动覆盖（redis4.0后已被官方弃用，建议使用hset）</p>
<p><strong>hmget</strong>:一次取多个值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hmset myhash field1 hello field2 world<br>OK<br>127.0.0.1:6379&gt; hmget myhash field1 field2<br>1) <span class="hljs-string">&quot;hello&quot;</span><br>2) <span class="hljs-string">&quot;world&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>hgetall</strong>：获取hash中所有的键值对 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hgetall myhash<br>1) <span class="hljs-string">&quot;field1&quot;</span><br>2) <span class="hljs-string">&quot;hello&quot;</span><br>3) <span class="hljs-string">&quot;field2&quot;</span><br>4) <span class="hljs-string">&quot;world&quot;</span><br><br></code></pre></td></tr></table></figure>

<p><strong>hdel myhash field1</strong>：删除myhash 中的field1，即删除hash中指定的key，对应的value值也被删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hdel myhash field1<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; HGETALL myhash<br>1) <span class="hljs-string">&quot;field2&quot;</span><br>2) <span class="hljs-string">&quot;world&quot;</span><br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<p><strong>hlen myhash：</strong>查看myhash中key的个数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hgetall myhash<br>1) <span class="hljs-string">&quot;field2&quot;</span><br>2) <span class="hljs-string">&quot;world&quot;</span><br>3) <span class="hljs-string">&quot;field1&quot;</span><br>4) <span class="hljs-string">&quot;hello&quot;</span><br>127.0.0.1:6379&gt; hlen myhash<br>(<span class="hljs-built_in">integer</span>) 2<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>hexists</strong>：判断hash中的某一个字段是否存在</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hexists myhash field1<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; hexists myhash field3<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; <br><br></code></pre></td></tr></table></figure>

<p><strong>hkeys myhash：</strong>获取myhash中所有的key</p>
<p><strong>hvals myhash：</strong>获取myhash中所有的value</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hkeys myhash<br>1) <span class="hljs-string">&quot;field2&quot;</span><br>2) <span class="hljs-string">&quot;field1&quot;</span><br>127.0.0.1:6379&gt; hvals myhash<br>1) <span class="hljs-string">&quot;world&quot;</span><br>2) <span class="hljs-string">&quot;hello&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>hincrby：</strong>自增</p>
<p><strong>hsetnx：</strong>判断是否存在，如果存在则不创建，不存在则新建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; hset myhash field3 5(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; hincrby myhash field3 1				<span class="hljs-comment"># 自增1(integer) 6127.0.0.1:6379&gt; hincrby myhash field3 -1(integer) 5127.0.0.1:6379&gt; hsetnx myhash field4 hello			# field4不存在，新建(integer) 1127.0.0.1:6379&gt; HGETALL myhash1) &quot;field2&quot;2) &quot;world&quot;3) &quot;field1&quot;4) &quot;hello&quot;5) &quot;field3&quot;6) &quot;5&quot;7) &quot;field4&quot;8) &quot;hello&quot;127.0.0.1:6379&gt; hsetnx myhash field4 hello			# field4已经存在，创建失败(integer) 0127.0.0.1:6379&gt; </span><br></code></pre></td></tr></table></figure>

<p>hash变更的数据 user name age ，尤其是用户信息之类的，经常变动的信息。hash更适合对象的存储，String更加适合字符串。 </p>
<h2 id="Zset-有序集合"><a href="#Zset-有序集合" class="headerlink" title="Zset(有序集合)"></a>Zset(有序集合)</h2><p>在set的基础上，增加了一个值，set k1 v1 ，zset k1 score1 v1</p>
<p><strong>zadd</strong>:添加</p>
<p><strong>zrange</strong>:查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; zadd zset 1 one(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; zadd zset 2 two(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; zadd zset 3 three(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; ZRANGE zset 0 -11) <span class="hljs-string">&quot;one&quot;</span>2) <span class="hljs-string">&quot;two&quot;</span>3) <span class="hljs-string">&quot;three&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>zrangebyscore：</strong>通过score排序</p>
<p><strong>zrevrange</strong>:降序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; zadd salary 2500 xiaohong<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; zadd salary 5000 zhangsan<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; zadd salary 200 Ten<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; zrangebyscore salary -inf +inf				<span class="hljs-comment"># 显示所有用户，从小到大排序，不带score排序</span><br>1) <span class="hljs-string">&quot;Ten&quot;</span><br>2) <span class="hljs-string">&quot;xiaohong&quot;</span><br>3) <span class="hljs-string">&quot;zhangsan&quot;</span><br>127.0.0.1:6379&gt; zrangebyscore salary -inf +inf withscores	<span class="hljs-comment"># 带有score排序</span><br>1) <span class="hljs-string">&quot;Ten&quot;</span><br>2) <span class="hljs-string">&quot;200&quot;</span><br>3) <span class="hljs-string">&quot;xiaohong&quot;</span><br>4) <span class="hljs-string">&quot;2500&quot;</span><br>5) <span class="hljs-string">&quot;zhangsan&quot;</span><br>6) <span class="hljs-string">&quot;5000&quot;</span><br>127.0.0.1:6379&gt; ZRANGE salary 0 -1<br>1) <span class="hljs-string">&quot;Ten&quot;</span><br>2) <span class="hljs-string">&quot;zhangsan&quot;</span><br>127.0.0.1:6379&gt; ZREVRANGE salary 0 -1						<span class="hljs-comment"># 降序，从高到底</span><br>1) <span class="hljs-string">&quot;zhangsan&quot;</span><br>2) <span class="hljs-string">&quot;Ten&quot;</span><br>127.0.0.1:6379&gt; ZREVRANGE salary 0 -1 withscores<br>1) <span class="hljs-string">&quot;zhangsan&quot;</span><br>2) <span class="hljs-string">&quot;5000&quot;</span><br>3) <span class="hljs-string">&quot;Ten&quot;</span><br>4) <span class="hljs-string">&quot;200&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>zrem：</strong>移除元素</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; ZRANGE salary 0 -1<br>1) <span class="hljs-string">&quot;Ten&quot;</span><br>2) <span class="hljs-string">&quot;xiaohong&quot;</span><br>3) <span class="hljs-string">&quot;zhangsan&quot;</span><br>127.0.0.1:6379&gt; zrem salary xiaohong<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; ZRANGE salary 0 -1<br>1) <span class="hljs-string">&quot;Ten&quot;</span><br>2) <span class="hljs-string">&quot;zhangsan&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>zcard</strong>:获取有序集合中的个数</p>
<p><strong>zcount</strong>：获取指范围之间的个数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; zadd myzset 1 hello 2 world 3 Ten<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; zcount myzset 1 3<br>(<span class="hljs-built_in">integer</span>) 3<br>127.0.0.1:6379&gt; zcount myzset 1 2<br>(<span class="hljs-built_in">integer</span>) 2<br>127.0.0.1:6379&gt; zcount myzset 0 1<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; zcount myzset 0 2<br>(<span class="hljs-built_in">integer</span>) 2<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>案例思路：set 排序，存储班级成绩表，工资表排序</p>
<p>普通消息 1 ，重要消息 2 ，带权重进行判断！</p>
<p>排行榜应用实现，取Top N测试。</p>
<h1 id="三种特殊数据类型"><a href="#三种特殊数据类型" class="headerlink" title="三种特殊数据类型"></a>三种特殊数据类型</h1><h2 id="geospatail-地理位置"><a href="#geospatail-地理位置" class="headerlink" title="geospatail 地理位置"></a>geospatail 地理位置</h2><p>朋友的定位，附近的人，打车的距离计算</p>
<p>redis的geo在redis3.2版本就推出了。这个功能可以推算地理位置的信息，两地之间的距离，方圆几里的人。</p>
<p><strong>geoadd</strong>：添加地址位置</p>
<p>规则：两极无法直接添加，我们一般会下载城市数据，直接通过java程序一次性导入</p>
<p>有效的经度从-180度到180度</p>
<p>有效的纬度从-85.05112878到85.05112878度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; geoadd china:city 116.40 39.90 beijing(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; geoadd china:city 106.20 29.53 chongqin 114.05 22.52 shengzhen(<span class="hljs-built_in">integer</span>) 2127.0.0.1:6379&gt; geoadd china:city 120.16 30.24 hangzhou 108.96 34.26 xian(<span class="hljs-built_in">integer</span>) 2127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>geopos</strong>：获取位置信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; geopos china:city beijing1) 1) <span class="hljs-string">&quot;116.39999896287918091&quot;</span>   2) <span class="hljs-string">&quot;39.90000009167092543&quot;</span>127.0.0.1:6379&gt; geopos china:city chongqin1) 1) <span class="hljs-string">&quot;106.19999796152114868&quot;</span>   2) <span class="hljs-string">&quot;29.52999957900659211&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>geodist</strong>：</p>
<p>两人之间的距离</p>
<p>单位：</p>
<ul>
<li><strong>m</strong>表示单位为米</li>
<li><strong>km</strong>表示单位为千米</li>
<li><strong>mi</strong>表示单位为英里</li>
<li><strong>ft</strong>表示单位为英尺</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; GEODIST china:city beijing shanghai<span class="hljs-string">&quot;1067378.7564&quot;</span>127.0.0.1:6379&gt; GEODIST china:city beijing shanghai km<span class="hljs-string">&quot;1067.3788&quot;</span>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>georedius</strong>：以给定的经纬度为中心，找出某一半径的元素</p>
<p>附近的人？（获得所有附近的地址，定位！）通过半径来查询。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">27.0.0.1:6379&gt; GEORADIUS china:city 110 30 100000 km	 <span class="hljs-comment"># 以110，30 这个经纬度为中心，寻找方圆1000km内的城市</span><br>1) <span class="hljs-string">&quot;chongqin&quot;</span><br>2) <span class="hljs-string">&quot;xian&quot;</span><br>3) <span class="hljs-string">&quot;shengzhen&quot;</span><br>4) <span class="hljs-string">&quot;hangzhou&quot;</span><br>5) <span class="hljs-string">&quot;shanghai&quot;</span><br>6) <span class="hljs-string">&quot;beijing</span><br><span class="hljs-string">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 1000 km</span><br><span class="hljs-string">1) &quot;</span>chongqin<span class="hljs-string">&quot;</span><br><span class="hljs-string">2) &quot;</span>xian<span class="hljs-string">&quot;</span><br><span class="hljs-string">3) &quot;</span>shengzhen<span class="hljs-string">&quot;</span><br><span class="hljs-string">4) &quot;</span>hangzhou<span class="hljs-string">&quot;</span><br><span class="hljs-string">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist		# 带有直线距离</span><br><span class="hljs-string">1) 1) &quot;</span>chongqin<span class="hljs-string">&quot;</span><br><span class="hljs-string">   2) &quot;</span>370.5852<span class="hljs-string">&quot;</span><br><span class="hljs-string">2) 1) &quot;</span>xian<span class="hljs-string">&quot;</span><br><span class="hljs-string">   2) &quot;</span>483.8340<span class="hljs-string">&quot;</span><br><span class="hljs-string">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withcoord	# 带有经纬度</span><br><span class="hljs-string">1) 1) &quot;</span>chongqin<span class="hljs-string">&quot;</span><br><span class="hljs-string">   2) 1) &quot;</span>106.19999796152114868<span class="hljs-string">&quot;</span><br><span class="hljs-string">      2) &quot;</span>29.52999957900659211<span class="hljs-string">&quot;</span><br><span class="hljs-string">2) 1) &quot;</span>xian<span class="hljs-string">&quot;</span><br><span class="hljs-string">   2) 1) &quot;</span>108.96000176668167114<span class="hljs-string">&quot;</span><br><span class="hljs-string">      2) &quot;</span>34.25999964418929977<span class="hljs-string">&quot;</span><br><span class="hljs-string">127.0.0.1:6379&gt; </span><br></code></pre></td></tr></table></figure>

<p>获得指定的个数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist withcoord count 1<br>1) 1) <span class="hljs-string">&quot;chongqin&quot;</span><br>   2) <span class="hljs-string">&quot;370.5852&quot;</span><br>   3) 1) <span class="hljs-string">&quot;106.19999796152114868&quot;</span><br>      2) <span class="hljs-string">&quot;29.52999957900659211&quot;</span><br>127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist withcoord count 2<br>1) 1) <span class="hljs-string">&quot;chongqin&quot;</span><br>   2) <span class="hljs-string">&quot;370.5852&quot;</span><br>   3) 1) <span class="hljs-string">&quot;106.19999796152114868&quot;</span><br>      2) <span class="hljs-string">&quot;29.52999957900659211&quot;</span><br>2) 1) <span class="hljs-string">&quot;xian&quot;</span><br>   2) <span class="hljs-string">&quot;483.8340&quot;</span><br>   3) 1) <span class="hljs-string">&quot;108.96000176668167114&quot;</span><br>      2) <span class="hljs-string">&quot;34.25999964418929977&quot;</span><br>127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist withcoord count 3<br>1) 1) <span class="hljs-string">&quot;chongqin&quot;</span><br>   2) <span class="hljs-string">&quot;370.5852&quot;</span><br>   3) 1) <span class="hljs-string">&quot;106.19999796152114868&quot;</span><br>      2) <span class="hljs-string">&quot;29.52999957900659211&quot;</span><br>2) 1) <span class="hljs-string">&quot;xian&quot;</span><br>   2) <span class="hljs-string">&quot;483.8340&quot;</span><br>   3) 1) <span class="hljs-string">&quot;108.96000176668167114&quot;</span><br>      2) <span class="hljs-string">&quot;34.25999964418929977&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>georediusbymember</strong>：以某个城市为中心，搜索方圆1000km的地方</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijing 1000 km<br>1) <span class="hljs-string">&quot;beijing&quot;</span><br>2) <span class="hljs-string">&quot;xian&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>geohash</strong>：返回一个或多个位置元素的geohash字符串,将二维的经纬度转换为一维的字符串</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; geohash china:city beijing chongqin<br>1) <span class="hljs-string">&quot;wx4fbxxfke0&quot;</span><br>2) <span class="hljs-string">&quot;wm5xbxu2xq0&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>geo 底层的实现原是Zset ，我们可以使用Zset命名来操作</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; zrange china:city 0 -1<br>1) <span class="hljs-string">&quot;chongqin&quot;</span><br>2) <span class="hljs-string">&quot;xian&quot;</span><br>3) <span class="hljs-string">&quot;shengzhen&quot;</span><br>4) <span class="hljs-string">&quot;hangzhou&quot;</span><br>5) <span class="hljs-string">&quot;shanghai&quot;</span><br>6) <span class="hljs-string">&quot;beijing&quot;</span><br>127.0.0.1:6379&gt; zrem china:city chongqin<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; zrange china:city 0 -1<br>1) <span class="hljs-string">&quot;xian&quot;</span><br>2) <span class="hljs-string">&quot;shengzhen&quot;</span><br>3) <span class="hljs-string">&quot;hangzhou&quot;</span><br>4) <span class="hljs-string">&quot;shanghai&quot;</span><br>5) <span class="hljs-string">&quot;beijing&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<h2 id="Hyperloglog"><a href="#Hyperloglog" class="headerlink" title="Hyperloglog"></a>Hyperloglog</h2><p><strong>什么是基数？</strong>一个集合中的元素不重复元素的数量</p>
<p>A{1,3,5,7,8,7}</p>
<p>B{1,3,5,7,8}</p>
<p>基数（不重复的元素） = 5个 ，可以接收误差！</p>
<p><strong>简介</strong></p>
<p>redis 2.8.9版本就更新了Hyperloglog 数据结构！</p>
<p>Redis Hyperloglog 基数统计的算法！</p>
<p>优点：占用的内存是固定的，2^64不同的元素的技术，只需要12kb内存！如果要从内存角度来比较的话Hyperloglog首选</p>
<p><strong>网页的UV（一个人访问一个网站多次，但是还是算作一个人）</strong></p>
<p>传统的方式，set保存用户的id，然后就可以统计set中的元素数量作为标准判断！</p>
<p>这个方式如果保存大量的用户id，就会比较麻烦，我们的目的是为计数，而不是保存用户id。</p>
<p><strong>pfadd</strong>：添加</p>
<p><strong>pfcount：</strong>统计个数</p>
<p><strong>pfmerge</strong>：将两个集合合并，去除重复的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; pfadd mykey a b c d e f g h i j<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; PFCOUNT mykey<br>(<span class="hljs-built_in">integer</span>) 10<br>127.0.0.1:6379&gt; pfadd mykey2 i j z x c v b n m<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; PFCOUNT mykey2<br>(<span class="hljs-built_in">integer</span>) 9<br>127.0.0.1:6379&gt; PFMERGE mykey3 mykey mykey2<br>OK<br>127.0.0.1:6379&gt; PFCOUNT mykey3<br>(<span class="hljs-built_in">integer</span>) 15<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>如果允许容错，那么一定可以使用Hyperloglog。</p>
<p>如果不允许容错，就使用set或者自己的数据类型即可。</p>
<h2 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h2><p><strong>位存储</strong></p>
<p>统计用户信息，活跃，不活跃！登录、未登录！打卡，两个状态的，都可以使用Bitmap！</p>
<p>Bitmap位图，数据结构！都是操作二进制位来进行记录，就是只有0和1两个状态！</p>
<p><strong>setbit</strong>：存</p>
<p><strong>getbit</strong>：取</p>
<p><strong>bitcount</strong>:统计打卡天数</p>
<p>记录一周是否打卡，0未打卡，1已打卡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; setbit sign 0 1<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; setbit sign 1 0<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; setbit sign 2 0<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; setbit sign 3 1<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; setbit sign 4 1<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; setbit sign 5 1<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; setbit sign 6 0<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; getbit sign 4<br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; getbit sign 6<br>(<span class="hljs-built_in">integer</span>) 0<br>127.0.0.1:6379&gt; BITCOUNT sign <br>(<span class="hljs-built_in">integer</span>) 4<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>redis事务本质：一组命令的集合！一个事务中所有命令都会被序列化，在事务执行过程中，会按照顺序执行！</p>
<p>一次性、顺序性、排他性！执行一些列的命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">---- 队列 <span class="hljs-built_in">set</span> <span class="hljs-built_in">set</span> <span class="hljs-built_in">set</span> <span class="hljs-built_in">set</span> 执行 ----<br></code></pre></td></tr></table></figure>

<p>==redis事务没有隔离级别的概念==</p>
<p>所有的命令在事务中，并没有直接被执行，只有发起执行命令的时候才会执行！Exec</p>
<p>==redis单条命名是保证原子性的，但是事务不保证原子性==</p>
<p>redis的事务：</p>
<ul>
<li>开启事务（multi）</li>
<li>命令入队（…）</li>
<li>执行事务（exec）</li>
</ul>
<p><strong>正常执行事务：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; multi				<span class="hljs-comment"># 开启事务</span><br>OK<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k1 v1		<span class="hljs-comment"># 命令</span><br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k2 v2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k3 v3<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">exec</span>			<span class="hljs-comment"># 执行事务</span><br>1) OK<br>2) OK<br>3) <span class="hljs-string">&quot;v2&quot;</span><br>4) OK<br>127.0.0.1:6379&gt;<br></code></pre></td></tr></table></figure>

<p><strong>放弃事务：</strong>discard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k1 v1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k2 v2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k4 v4<br>QUEUED<br>127.0.0.1:6379(TX)&gt; DISCARD			<span class="hljs-comment"># 放弃事务</span><br>OK<br>127.0.0.1:6379&gt; get k4				<span class="hljs-comment"># 事务没有被执行到，所以找不到</span><br>(nil)<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>编译型异常</strong>（代码有问题！命令有错），事务中所有的命令都不会被执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k1 v1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k2 v2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; getset k3<br>(error) ERR wrong number of arguments <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;getset&#x27;</span> <span class="hljs-built_in">command</span><br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k4 v4<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">exec</span><br>(error) EXECABORT Transaction discarded because of previous errors.<br>127.0.0.1:6379&gt; get k4<br>(nil)<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p><strong>运行时异常</strong>（1/0），如果事务队列中存在语法性错误，那么执行命令的时候，其他命令是可以正常执行的，错误命令抛出异常。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> k1 <span class="hljs-string">&quot;v1&quot;</span><br>OK<br>127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; incr k1				<span class="hljs-comment"># 让字符串加一，语法没问题，但是实际结果会报错</span><br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k2 v2<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">set</span> k3 v3<br>QUEUED<br>127.0.0.1:6379(TX)&gt; get k3<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">exec</span><br>1) (error) ERR value is not an <span class="hljs-built_in">integer</span> or out of range<br>2) OK<br>3) OK<br>4) <span class="hljs-string">&quot;v3&quot;</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<h1 id="监控-Watch（面试常问）"><a href="#监控-Watch（面试常问）" class="headerlink" title="监控 Watch（面试常问）"></a>监控 Watch（面试常问）</h1><p><strong>悲观锁</strong></p>
<ul>
<li>很悲观，认为什么时候都会出问题，无论做什么都会加锁。</li>
</ul>
<p><strong>乐观锁</strong>：</p>
<ul>
<li>很乐观，认为什么时候都不会出问题，所以不上锁！更新数据的时候去判断一下，在此期间是否有人修改过这个数据</li>
<li>获取version</li>
<li>更新的时候比较version</li>
</ul>
<p><strong>redis监视测试</strong></p>
<p>正常执行成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> money 100<br>OK<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> out 0<br>OK<br>127.0.0.1:6379&gt; watch money			<span class="hljs-comment"># 监视money</span><br>OK<br>127.0.0.1:6379&gt; multi				<span class="hljs-comment"># 事务正常结束，数据期间没有发生变动，这个时候就正常执行成功</span><br>OK<br>127.0.0.1:6379(TX)&gt; DECRBY money 20<br>QUEUED<br>127.0.0.1:6379(TX)&gt; INCRBY out 20<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">exec</span><br>1) (<span class="hljs-built_in">integer</span>) 80<br>2) (<span class="hljs-built_in">integer</span>) 20<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p>测试多线程修改值，使用watch可以当做redis的乐观锁操作！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; watch money					<span class="hljs-comment"># 监视 money</span><br>OK<br>127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; DECRBY money 10<br>QUEUED<br>127.0.0.1:6379(TX)&gt; INCRBY out 10			<span class="hljs-comment"># 执行到这一行的时候，突然下面的线程二将money的值改变了</span><br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">exec</span>					<span class="hljs-comment"># 执行失败，因为money加了watch乐观锁</span><br>(nil)<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p>线程二：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; get money<br><span class="hljs-string">&quot;80&quot;</span><br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> money 1000<br>OK<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>



<p>如何解决？</p>
<p>先解锁，再去做其他的操作（事务执行结束之后，redis会自动解锁）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; unwatch					<span class="hljs-comment"># 解锁</span><br>OK<br>127.0.0.1:6379&gt; watch money				<span class="hljs-comment"># 获取最新的值，再次加监视</span><br>OK<br>127.0.0.1:6379&gt; multi<br>OK<br>127.0.0.1:6379(TX)&gt; DECRBY money 1<br>QUEUED<br>127.0.0.1:6379(TX)&gt; INCRBY out 1		<br>QUEUED<br>127.0.0.1:6379(TX)&gt; <span class="hljs-built_in">exec</span>				<span class="hljs-comment"># 对比监视的值是否发生了变化，如果没有，则执行成功</span><br>1) (<span class="hljs-built_in">integer</span>) 99<br>2) (<span class="hljs-built_in">integer</span>) 1<br></code></pre></td></tr></table></figure>



<h1 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h1><p>我们要使用java来操作redis</p>
<p>什么是Jedis？ 是redis官方推荐的java连接开发工具！使用java操作redis的<strong>中间件</strong>！如果你要使用java操作redis，那么一定要对Jedis十分熟悉。</p>
<p><strong>常用的API</strong></p>
<p>String</p>
<p>List</p>
<p>Set</p>
<p>Hash</p>
<p>Zset</p>
<p>所有的API命令，就是我们对应的上面学习的命令，一个都没有变化！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0-beta2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.78<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestTX</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        Jedis jedis = <span class="hljs-keyword">new</span> Jedis(<span class="hljs-string">&quot;192.168.242.3&quot;</span>, <span class="hljs-number">6379</span>);<br><br>        jedis.auth(<span class="hljs-string">&quot;123456&quot;</span>);<br><br>        JSONObject jsonObject = <span class="hljs-keyword">new</span> JSONObject();<br>        jsonObject.put(<span class="hljs-string">&quot;hello&quot;</span>,<span class="hljs-string">&quot;world&quot;</span>);<br>        jsonObject.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;Ten&quot;</span>);<br><br>        <span class="hljs-comment">// 开启事务</span><br>        Transaction multi = jedis.multi();<br><br>        String result = jsonObject.toJSONString();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            multi.set(<span class="hljs-string">&quot;user1&quot;</span>,result);<br>            multi.set(<span class="hljs-string">&quot;user2&quot;</span>,result);<br><br>            multi.exec();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// 放弃事务</span><br>            multi.discard();<br>            e.printStackTrace();<br><br>            System.out.println(jedis.get(<span class="hljs-string">&quot;user1&quot;</span>));<br>            System.out.println(jedis.get(<span class="hljs-string">&quot;user2&quot;</span>));<br><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            jedis.close();<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="SpringBoot-整合"><a href="#SpringBoot-整合" class="headerlink" title="SpringBoot 整合"></a>SpringBoot 整合</h1><p>SpringBoot操作数据：spring-data ,jpa,jdbc,mongodb,redis!</p>
<p>SpringData 也就是和SpringBoot齐名的项目</p>
<p>说明：在SpringBoot2.x之后，原来使用的jedis被替换为了lettuce。</p>
<p>jedis：采用的直连，多个线程操作的话，是不安全的，如果想要避免不安全的，使用jedis pool 连接池！BIO</p>
<p>lettuce：采用netty，实例可以在多个线程中进行共享，不存在线程不安全的情况！可以减少线程数据了。更像NIO模式</p>
<p>源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br> <span class="hljs-meta">@ConditionalOnMissingBean(			// 我们可以自己定义一个redisTemplate来替换这个默认的</span><br><span class="hljs-meta">     name = &#123;&quot;redisTemplate&quot;&#125;</span><br><span class="hljs-meta"> )</span><br> <span class="hljs-meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span><br> <span class="hljs-function"><span class="hljs-keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="hljs-title">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;<br>     <span class="hljs-comment">// 默认的RedisTemplate没有过多的设置，redis对象都是需要序列化</span><br>     <span class="hljs-comment">// 两个泛型都是Object, Object 的类型，我们后面使用需要强制转换&lt;String , Object&gt;</span><br>     RedisTemplate&lt;Object, Object&gt; template = <span class="hljs-keyword">new</span> RedisTemplate();<br>     template.setConnectionFactory(redisConnectionFactory);<br>     <span class="hljs-keyword">return</span> template;<br> &#125;<br><br> <span class="hljs-meta">@Bean</span><br> <span class="hljs-meta">@ConditionalOnMissingBean</span> 			<span class="hljs-comment">// 由于String是redis中最常用的使用类型，所以也单独提出来了一个bean</span><br> <span class="hljs-meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span><br> <span class="hljs-function"><span class="hljs-keyword">public</span> StringRedisTemplate <span class="hljs-title">stringRedisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;<br>     StringRedisTemplate template = <span class="hljs-keyword">new</span> StringRedisTemplate();<br>     template.setConnectionFactory(redisConnectionFactory);<br>     <span class="hljs-keyword">return</span> template;<br> &#125;<br></code></pre></td></tr></table></figure>



<ol>
<li><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.ten<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>02-redis-springboot<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>02-redis-springboot<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- redis整合SpringBoot --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure></li>
<li><p>配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 配置redis</span><br><span class="hljs-meta">spring.redis.host</span>=<span class="hljs-string">192.168.242.3</span><br><span class="hljs-meta">spring.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-meta">spring.redis.password</span>=<span class="hljs-string">123456			# redis设置了密码的需加这一行配置</span><br></code></pre></td></tr></table></figure></li>
<li><p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationTests</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">contextLoads</span><span class="hljs-params">()</span> </span>&#123;<br><br>        <span class="hljs-comment">// opsForValue 操作字符串 类似String</span><br>        <span class="hljs-comment">// opsForList 操作list 类似list</span><br>        <span class="hljs-comment">// redisTemplate.opsForList();</span><br><br>        <span class="hljs-comment">// 除了基本的操作，我们常用的方法都可以直接通过RedisTemplate操作，比如事务，和基本的CRUD</span><br><br>        <span class="hljs-comment">// 获取redis的连接对象</span><br>        <span class="hljs-comment">// RedisConnection connection = redisTemplate.getConnectionFactory().getConnection();</span><br>        <span class="hljs-comment">// connection.flushDb();</span><br><br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;mykey&quot;</span>,<span class="hljs-string">&quot;hello,world&quot;</span>);<br>        System.out.println(redisTemplate.opsForValue().get(<span class="hljs-string">&quot;mykey&quot;</span>));<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>关于数据的保存</p>
</li>
</ol>
<p><img src="/myBlog/Redis/image-20211109161652248-1636731414340.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211109161652248"></p>
<p>编写自己序列化配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisConfig</span> </span>&#123;<br><br>    <span class="hljs-comment">// 编写我们自己的配置类</span><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;<br><br>        <span class="hljs-comment">// 我们为了自己开发方便，一般直接使用&lt;String, Object&gt;</span><br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> RedisTemplate&lt;String, Object&gt; ();<br>        template.setConnectionFactory(redisConnectionFactory);<br><br>        <span class="hljs-comment">// json序列化配置</span><br>        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="hljs-keyword">new</span> Jackson2JsonRedisSerializer(Object.class);<br>        ObjectMapper om = <span class="hljs-keyword">new</span> ObjectMapper();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br><br>        <span class="hljs-comment">// String序列化</span><br>        StringRedisSerializer stringRedisSerializer = <span class="hljs-keyword">new</span> StringRedisSerializer();<br><br>        <span class="hljs-comment">// key采用string的序列化方式</span><br>        template.setKeySerializer(stringRedisSerializer);<br><br>        <span class="hljs-comment">// hash的key也采用String的序列化方式</span><br>        template.setHashKeySerializer(stringRedisSerializer);<br><br>        <span class="hljs-comment">// value序列化方式采用Jackson</span><br>        template.setValueSerializer(jackson2JsonRedisSerializer);<br><br>        <span class="hljs-comment">// hash的value序列化方式采用jackson</span><br>        template.setHashKeySerializer(jackson2JsonRedisSerializer);<br><br>        template.afterPropertiesSet();<br><br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>实际开发，为了方便，可以将这些方法抽取成工具类。（网上搜索RedisUtils有很多，具体结合实际项目）</p>
<p>思路：</p>
<ol>
<li>导入依赖</li>
<li>编写配置文件</li>
<li>测试</li>
<li>根据实际要求，编写自己需要的序列化配置文件</li>
<li>将redis中的方法抽取出来，做成工具类，以便后期开发使用。</li>
</ol>
<h1 id="Redis-conf详解"><a href="#Redis-conf详解" class="headerlink" title="Redis.conf详解"></a>Redis.conf详解</h1><ol>
<li><p>配置文件unit单位对大小写不敏感。</p>
<p><img src="/myBlog/Redis/image-20211109193951137-1636731414341.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211109193951137"></p>
</li>
<li><p>包含，就好比我们学习Spring、import，include</p>
<p><img src="/myBlog/Redis/image-20211109194709896-1636731414341.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211109194709896"></p>
</li>
<li><p>网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">bind</span> 127.0.0.1 -::1		<span class="hljs-comment"># 绑定的ip</span><br>protected-mode yes		<span class="hljs-comment"># 保护模式</span><br>port 6379				<span class="hljs-comment"># 端口设置</span><br></code></pre></td></tr></table></figure></li>
<li><p>通用GENERAL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">daemonize yes						<span class="hljs-comment"># 以守护进程的方式运行（后台运行），默认是no，需要修改为yes</span><br>pidfile /var/run/redis_6379.pid		<span class="hljs-comment"># 如果以后台的方式运行，我们就需要指定一个pid文件</span><br><br><span class="hljs-comment"># 日志</span><br><span class="hljs-comment"># Specify the server verbosity level.</span><br><span class="hljs-comment"># This can be one of:</span><br><span class="hljs-comment"># debug (a lot of information, useful for development/testing)</span><br><span class="hljs-comment"># verbose (many rarely useful info, but not a mess like the debug level)</span><br><span class="hljs-comment"># notice (moderately verbose, what you want in production probably)				生产环境</span><br><span class="hljs-comment"># warning (only very important / critical messages are logged)</span><br>loglevel notice<br>logfile <span class="hljs-string">&quot;&quot;</span>					<span class="hljs-comment"># 日志生成的文件位置名，如果为空，则为默认的位置输出</span><br>databases 16				<span class="hljs-comment"># 默认数据库数量为16个</span><br>always-show-logo no			<span class="hljs-comment"># 是否总是显示logo（开启服务时，数据库的logo）</span><br><br></code></pre></td></tr></table></figure></li>
<li><p>快照</p>
<p>持久化，在规定的时间内，执行了多少次操作，则会持久化到文件 .rdb .aof</p>
<p>redis是内存数据库，如果没有持久化，那么数据断点就会丢失！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">save 3600 1							<span class="hljs-comment"># 如果900秒内，至少有1个key进行了修改，我们就进行持久化操作</span><br>save 300 100						<span class="hljs-comment"># 如果300秒内，至少有100个key进行了修改，我们就进行持久化操作</span><br>save 60 10000						<span class="hljs-comment"># 如果60秒内，至少有10000个key进行了修改，我们就进行持久化操作</span><br><br><span class="hljs-comment"># 我们后面学习持久化，会自己定义这个测试</span><br><br>stop-writes-on-bgsave-error yes		<span class="hljs-comment"># 当bgsave快照操作出错时停止写数据到磁盘</span><br><br>rdbcompression yes					<span class="hljs-comment"># 是否压缩rdb文件，需要消耗一些cpu资源</span><br>rdbchecksum yes						<span class="hljs-comment"># 保存rdb文件的时候，进行错误的检查校验</span><br>dir ./								<span class="hljs-comment"># rdb持久化保存文件的目录</span><br></code></pre></td></tr></table></figure></li>
<li><p>REPLICATION 复制，我们后面讲解主从复制的时候再讲解</p>
</li>
<li><p>SECURITY 安全</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">config <span class="hljs-built_in">set</span> requirepass <span class="hljs-string">&quot;123456&quot;</span>		<span class="hljs-comment"># 设置redis密码</span><br>config get requirepass				<span class="hljs-comment"># 获得密码</span><br>auth 123456							<span class="hljs-comment"># 使用密码登录认证</span><br></code></pre></td></tr></table></figure>

</li>
<li><p>限制CLIENTS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">maxclients 10000					<span class="hljs-comment"># 设置能连接上redis的客户端的最大数量</span><br>maxmemory &lt;bytes&gt;					<span class="hljs-comment"># redis 配置最大的内存容量</span><br>maxmemory-policy noeviction			<span class="hljs-comment"># 内存到达上限之后的处理策略</span><br><br>1、volatile-lru：只对设置了过期时间的key进行LRU（默认值） <br>2、allkeys-lru ： 删除lru算法的key   <br>3、volatile-random：随机删除即将过期key   <br>4、allkeys-random：随机删除   <br>5、volatile-ttl ： 删除即将过期的   <br>6、noeviction ： 永不过期，返回错误<br></code></pre></td></tr></table></figure></li>
<li><p>APPEND ONLY 模式 aof配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">appendonly no						<span class="hljs-comment"># 默认是不开启aof模式的，默认使用rdb方式持久化的，在大部分情况下，rdb够用了</span><br>appendfilename <span class="hljs-string">&quot;appendonly.aof&quot;</span> 	<span class="hljs-comment"># 持久化文件的名字</span><br><br><span class="hljs-comment"># appendfsync always				# 每次修改都会sync。消耗性能</span><br>appendfsync everysec				<span class="hljs-comment"># 每秒执行一次 sync ，可能会丢失这1s的数据！</span><br><span class="hljs-comment"># appendfsync no					# 不执行sync，这个时候操作系统自己同步数据，速度最快</span><br><br></code></pre></td></tr></table></figure></li>
</ol>
<h1 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h1><p>面试和工作，持久化都是重点！</p>
<p>Redis是内存数据库，如果不将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库状态也会消失。所以Redis提供了持久化功能！</p>
<h2 id="RDB（RedisDataBase）"><a href="#RDB（RedisDataBase）" class="headerlink" title="RDB（RedisDataBase）"></a>RDB（RedisDataBase）</h2><p>什么是RDB？ </p>
<p><img src="/myBlog/Redis/image-20211110111343837-1636731446157.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110111343837"></p>
<p>在指定的时间间隔内将内存中的数据极快写入磁盘，也就是行话说Snapshot快照，他恢复时是将快照文件直接读到内存里。</p>
<p>Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的。这就确保了极高的性能。如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常灵敏，那RDB方法要比AOF方式更加的高效。RDB的缺点是最后一次持久化后的数据可能会丢失。我们默认的就是RDB，一般情况下不需要修改这个配置！</p>
<p>==rdb保存的文件是dump.rdb==,都是在配置文件中的快照选项中配置的。</p>
<p><img src="/myBlog/Redis/image-20211110115128561-1636731446157.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110115128561"></p>
<p><strong>触发机制</strong></p>
<ol>
<li>save的规则满足的情况下，会自动触发rdb规则</li>
<li>执行flushall命令，也会触发我们的rdb规则</li>
<li>退出redis，也会产生rdb文件 </li>
</ol>
<p>备份完就自动生成一个dump.rdb</p>
<p><strong>如何恢复rdb文件</strong></p>
<ol>
<li><p>只需要将rdb文件放在我们redis启动目录就可以，redis启动的时候会自动检查dump.rdb恢复其中的数据。</p>
</li>
<li><p>查看需要存放的位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; config get dir<br>1) <span class="hljs-string">&quot;dir&quot;</span><br>2) <span class="hljs-string">&quot;/usr/local/bin&quot;</span>					<span class="hljs-comment"># 如果在这个目录下存在dump.rdb文件，启动就会自动恢复其中的数据。</span><br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">appendonly no						<span class="hljs-comment"># 默认是不开启aof模式的，默认使用rdb方式持久化的，在大部分情况下，rdb够用了</span><br>appendfilename <span class="hljs-string">&quot;appendonly.aof&quot;</span> 	<span class="hljs-comment"># 持久化文件的名字</span><br><br><span class="hljs-comment"># appendfsync always				# 每次修改都会sync。消耗性能</span><br>appendfsync everysec				<span class="hljs-comment"># 每秒执行一次 sync ，可能会丢失这1s的数据！</span><br><span class="hljs-comment"># appendfsync no					# 不执行sync，这个时候操作系统自己同步数据，速度最快</span><br><br></code></pre></td></tr></table></figure></li>
</ol>
<p><strong>重写规则说明</strong></p>
<p>aof默认的是无限追加，文件会越来远大。</p>
<p><img src="/myBlog/Redis/image-20211110125255401-1636731446158.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110125255401"></p>
<p><img src="/myBlog/Redis/image-20211110125322034-1636731446158.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110125322034"></p>
<p>如果aof文件大于64m，将fork一个新的进程来将我们的文件进行重写。</p>
<p><strong>优点：</strong></p>
<ol>
<li>适合大规模的数据恢复！dump.rdb</li>
<li>对数据的完整性要求不高</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>需要一定的时间间隔进行操作。如果redis意外宕机了，这个最后的一次修改数据就没了。</li>
<li>fork进程的时候，会占用一定的内容空间。</li>
</ol>
<h2 id="AOF（Append-Only-File）"><a href="#AOF（Append-Only-File）" class="headerlink" title="AOF（Append Only File）"></a>AOF（Append Only File）</h2><p>将我们所有的命令都记录下来，history，恢复的时候就把这个文件全部在执行一遍。</p>
<p>以日志形式来记录每个写操作，将redis执行过的执行记录下来（读操作不记录），只 许追加文件不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p>
<p>aof保存的是appendonly.aof 文件</p>
<p><strong>append</strong></p>
<p><img src="/myBlog/Redis/image-20211110122837901-1636731446158.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110122837901"></p>
<p>默认是不开启的，我们需要手动进行配置。我们只需要将appendonly改为yes就可以开启aof了</p>
<p>重启，redis就可以生效了。</p>
<p><img src="/myBlog/Redis/image-20211110123055770-1636731446158.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110123055770"></p>
<p>如果这个aof文件有错误，这时候redis是启动不起来的，我们需要修复这个aof文件，redis给我们提供了这样一个工具<code>redis-check-aof</code> （删掉错误的代码）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># redis-check-aof --fix appendonly.aof</span><br><br>[root@localhost bin]<span class="hljs-comment"># ./redis-check-aof --fix appendonly.aof </span><br>0x              87: Expected \r\n, got: 6661<br>AOF analyzed: size=153, ok_up_to=110, ok_up_to_line=33, diff=43<br>This will shrink the AOF from 153 bytes, with 43 bytes, to 110 bytes<br>Continue? [y/N]: y<br>Successfully truncated AOF<br>[root@localhost bin]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure>

<p>如果文件正常了，启动redis就可以恢复了。</p>
<p>优点：</p>
<ol>
<li>每次修改都会同步，文件的完整会更加好！</li>
<li>每秒同步一次，可能会丢失一秒的数据</li>
<li>从不同步，效率最高。</li>
</ol>
<p>缺点：</p>
<ol>
<li>相对于数据文件来说，aof远远大于rdb，修复的速度也被rdb慢。</li>
<li>aof运行效率也要比rdb慢，所以我们redis默认的配置就是rdb持久化！</li>
</ol>
<h1 id="Redis发布订阅"><a href="#Redis发布订阅" class="headerlink" title="Redis发布订阅"></a>Redis发布订阅</h1><p>Redis发布订阅（pub/sub)是一种==消息通信模式==：发送者(pub)发送消息，订阅者(sub)接收消息。微信、微博、关注系统。</p>
<p>Redis客户端可以订阅任意数量的频道</p>
<p>订阅/发布消息图：</p>
<p>第一个：消息发送者，第二个：频道，第三个：消息订阅者</p>
<p><img src="/myBlog/Redis/image-20211110141642042-1636731446158.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110141642042"></p>
<p>下图展示了频道channel1，以及订阅这个频道的三个客户端——client2、client5、client1之间的关系：</p>
<p><img src="/myBlog/Redis/image-20211110142031866-1636731446158.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110142031866"></p>
<p>当有新消息通过publish命令发送到频道channel1时，这个消息会被发送给订阅他的三个客户端：</p>
<p><img src="/myBlog/Redis/image-20211110142125541-1636731446169.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110142125541"></p>
<p><strong>命令</strong></p>
<p>这些命令被广泛用于构建即时通信应用，比如网络聊天室（chatroom)和实时广播、实时提醒等。</p>
<p><img src="/myBlog/Redis/image-20211110142435094-1636731446169.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110142435094"></p>
<p><strong>测试</strong></p>
<p>先订阅一个频道Ten</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; SUBSCRIBE Ten<br>Reading messages... (press Ctrl-C to quit)<br>1) <span class="hljs-string">&quot;subscribe&quot;</span><br>2) <span class="hljs-string">&quot;Ten&quot;</span><br>3) (<span class="hljs-built_in">integer</span>) 1<br></code></pre></td></tr></table></figure>

<p>再开一个进程，发布消息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; PUBLISH Ten <span class="hljs-string">&quot;hello Ten&quot;</span><br>(<span class="hljs-built_in">integer</span>) 1<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>最后频道这么就会自动更新内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; SUBSCRIBE Ten<br>Reading messages... (press Ctrl-C to quit)<br>1) <span class="hljs-string">&quot;subscribe&quot;</span><br>2) <span class="hljs-string">&quot;Ten&quot;</span><br>3) (<span class="hljs-built_in">integer</span>) 1<br>1) <span class="hljs-string">&quot;message&quot;</span><br>2) <span class="hljs-string">&quot;Ten&quot;</span><br>3) <span class="hljs-string">&quot;hello Ten&quot;</span><br></code></pre></td></tr></table></figure>



<h1 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h1><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>主从复制,是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master/leader)，后者称为从节点(slave/follower)；==数据的复制是单向的，只能由主节点到从节点==。Master以写为主 ，Slave以读为主。</p>
<p>==默认情况下，每台Redis服务器都是主节点==；且一个主节点可以有多个从节点(或没有从节点) ，但一个从节点只能有一个主节点。</p>
<p>主从复制的作用主要包括：</p>
<ol>
<li><p>数据冗余：主从复制实现了数据的热备份,是持久化之外的一种数据冗余方式。</p>
</li>
<li><p>故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</p>
</li>
<li><p>负载均衡：在主从复制的基础，上配合读写分离，可以由主节点提供写服务，由从节点提供读服务(即写Redis数据时应用连接</p>
<p>主节点，读Redis数据时应用连接从节点) ， 分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大</p>
<p>大提高Redis服务器的并发量。</p>
</li>
<li><p>高可用（集群）基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。</p>
</li>
</ol>
<p>一般来说,要将Redis运用于工程项目中，只使用一台Redis是万万不能的（宕机），原因如下：</p>
<ol>
<li>从结构上，单个Redis服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大；</li>
<li>从容量上，单个Redis服务器内存容量有限，就算一台Redis服务器内存容量为256G ，也不能将所有内存用作Redis存储内存，一般来说，==单台Redis最大使用内存不应该超过20G==。</li>
</ol>
<p>电商网站上的商品，一般都是一次上传，无数次浏览的，说专业点也就是”多读少写”。</p>
<p>对于这种场景我们可以使如下这种架构 ：</p>
<p><img src="/myBlog/Redis/image-20211110160627503-1636731465018.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110160627503"></p>
<p>主从复制，读写分离！80%的情况下都是在进行读操作！减缓服务器的压力。架构中经常使用。一主二从。</p>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>只配置从库，不用配置主库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; info replication							<span class="hljs-comment"># 查看当前库的信息</span><br><span class="hljs-comment"># Replication												</span><br>role:master													<span class="hljs-comment"># 角色master</span><br>connected_slaves:0											<span class="hljs-comment"># 没有从机	</span><br>master_failover_state:no-failover<br>master_replid:c24b4990216f9f43edd239880dd084fb611f24d6<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>复制三个文件，修改对应的信息</p>
<ol>
<li>端口</li>
<li>pid名字</li>
<li>log文件名字</li>
<li>dump.rdb名字</li>
</ol>
<p><img src="/myBlog/Redis/image-20211110164938440-1636731465018.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110164938440"></p>
<h3 id="一主二从"><a href="#一主二从" class="headerlink" title="一主二从"></a>一主二从</h3><p>==默认情况下，每台Redis服务器都是主节点==；我们一般情况下只用配置从机就好了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">slaveof 127.0.0.1 6379			<span class="hljs-comment"># 找主机</span><br><br></code></pre></td></tr></table></figure>

<p>主机有密码的，在从机的配置文件conf里加上：masterpass 密码</p>
<p>主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=127.0.0.1,port=6381,state=online,offset=56,lag=1<br>slave1:ip=127.0.0.1,port=6380,state=online,offset=56,lag=0<br>master_failover_state:no-failover<br>master_replid:9a9b9c66882dedab9eeacbc42faaea7da17252c5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:56<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:56<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>从机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6380&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave<br>master_host:127.0.0.1<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:10<br>master_sync_in_progress:0<br>slave_read_repl_offset:28<br>slave_repl_offset:28<br>slave_priority:100<br>slave_read_only:1<br>replica_announced:1<br>connected_slaves:0<br>master_failover_state:no-failover<br>master_replid:9a9b9c66882dedab9eeacbc42faaea7da17252c5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:28<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:28<br>127.0.0.1:6380&gt; <br></code></pre></td></tr></table></figure>



<p><strong>细节</strong></p>
<p>主机可以写，从机不可以写，只能读！主机中的所有信息和数据，都会自动被从机保存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; keys *<br>(empty array)<br>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> k1 v1<br>OK<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p>从机只读</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">127.0.0.1:6380&gt; keys *<br>1) <span class="hljs-string">&quot;k1&quot;</span><br>127.0.0.1:6380&gt; get k1<br><span class="hljs-string">&quot;v1&quot;</span><br>127.0.0.1:6380&gt; <span class="hljs-built_in">set</span> k2 v2<br>(error) READONLY You can<span class="hljs-string">&#x27;t write against a read only replica.</span><br><span class="hljs-string">127.0.0.1:6380&gt;</span><br></code></pre></td></tr></table></figure>

<p>测试：主机断开连接，从机依旧连接到主机的，但是没有写操作了，这个时候，主机如果回来了依旧可以获取到主机写的信息！</p>
<p>如果是使用命令行，来配置的主从，这个时候如果重启了，就会变成主机！只要变为从机，立马就会从主机中获取值！</p>
<p><strong>复制原理</strong></p>
<p>Slave启动成功连接到master后会发送一个sync命令</p>
<p>Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，==master将传送整个数据文件到slave，并完成一次完全同步==。</p>
<p>==全量复制==：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。</p>
<p>==增量复制==：Master继续将新的所有收集到的修改命令依次传给slave，完成同步</p>
<p>但是只要是重新连接master，一次完全同步（全量复制）将被自动执行。</p>
<p><strong>层层链路</strong></p>
<p>上一个M链接下一个S,也可以完成主从复制。</p>
<p><img src="/myBlog/Redis/image-20211110193759690-1636731465019.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110193759690"></p>
<p>如果主机断开了连接，我们可以使用<code>SLAVEOF no one</code>手动变成主机。其他节点就可以手动连接到这个最新的主机 </p>
<h3 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h3><p>（自动选举主机的模式）</p>
<p><strong>概述</strong></p>
<p>主从切换技术的方法是：当主服务器宕机后，需要手动把一台服务器切换为主服务器，这就需要人工干预，费时费力，还会造成一段时间内服务不可用。这不是推荐的方式，更多的时候，我们优先考虑哨兵模式。Redis从2.8开始正式提供了Sentinel（哨兵）架构来解决这个问题。</p>
<p>自动版，能够后台监控主机是否故障，如果故障了根据投票数==自动将从库转换为主库==。</p>
<p>哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。</p>
<p><img src="/myBlog/Redis/image-20211110200036007-1636731465018.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110200036007"></p>
<p>这里的哨兵的两个作用</p>
<ul>
<li>通过发送命令，让Redis服务器返回监控其运行状态，包括主服务器和从服务器。</li>
<li>当哨兵检测到了master宕机，会自动将slave切换成master，然后通过==发布订阅模式==通知其他的从服务器，修改配置文件，让它们切换主机</li>
</ul>
<p>然而一个哨兵进程对Redis服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还回进行监控，这样就行程了多哨兵的模式。</p>
<p><img src="/myBlog/Redis/image-20211110202645563-1636731465019.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110202645563"></p>
<p>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover（故障转移）操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线</strong>。</p>
<p><strong>测试</strong></p>
<ol>
<li><p>配置哨兵配置文件sentinel.config</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># sentinel monitor 被监视的名称 host port 1sentinel monitor myredis 127.0.0.1 6379 1</span><br></code></pre></td></tr></table></figure>

<p>后面的1，代表主机挂了之后，slave投票看让谁接替成为主机。</p>
</li>
<li><p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost bin]<span class="hljs-comment"># ./redis-sentinel ./myredisconf/sentinel.conf		# 启动</span><br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost bin]<span class="hljs-comment"># ./redis-sentinel ./myredisconf/sentinel.conf </span><br>8463:X 10 Nov 2021 20:38:26.820 <span class="hljs-comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br>8463:X 10 Nov 2021 20:38:26.820 <span class="hljs-comment"># Redis version=6.2.6, bits=64, commit=00000000, modified=0, pid=8463, just started</span><br>8463:X 10 Nov 2021 20:38:26.820 <span class="hljs-comment"># Configuration loaded</span><br>8463:X 10 Nov 2021 20:38:26.821 * Increased maximum number of open files to 10032 (it was originally <span class="hljs-built_in">set</span> to 1024).<br>8463:X 10 Nov 2021 20:38:26.821 * monotonic clock: POSIX clock_gettime<br>                _._                                                  <br>           _.-``__ <span class="hljs-string">&#x27;&#x27;</span>-._                                             <br>      _.-``    `.  `_.  <span class="hljs-string">&#x27;&#x27;</span>-._           Redis 6.2.6 (00000000/0) 64 bit<br>  .-`` .-```.  ```\/    _.,_ <span class="hljs-string">&#x27;&#x27;</span>-._                                  <br> (    <span class="hljs-string">&#x27;      ,       .-`  | `,    )     Running in sentinel mode</span><br><span class="hljs-string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="hljs-string">&#x27;|     Port: 26379</span><br><span class="hljs-string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 8463<br>  `-._    `-._  `-./  _.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br> |`-._`-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>_.-<span class="hljs-string">&#x27;|                                  </span><br><span class="hljs-string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="hljs-string">&#x27;    |           https://redis.io       </span><br><span class="hljs-string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br> |`-._`-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>_.-<span class="hljs-string">&#x27;|                                  </span><br><span class="hljs-string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="hljs-string">&#x27;    |                                  </span><br><span class="hljs-string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                   <br>      `-._    `-.__.-<span class="hljs-string">&#x27;    _.-&#x27;</span>                                       <br>          `-._        _.-<span class="hljs-string">&#x27;                                           </span><br><span class="hljs-string">              `-.__.-&#x27;</span>                                               <br><br>8463:X 10 Nov 2021 20:38:26.822 <span class="hljs-comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br>8463:X 10 Nov 2021 20:38:26.837 <span class="hljs-comment"># Sentinel ID is bd3c3a2017d9d9c4ee03c810ae071661cd4be1d7</span><br>8463:X 10 Nov 2021 20:38:26.837 <span class="hljs-comment"># +monitor master myredis 127.0.0.1 6379 quorum 1</span><br>8463:X 10 Nov 2021 20:38:26.838 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379<br>8463:X 10 Nov 2021 20:39:37.137 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379<br></code></pre></td></tr></table></figure>

<p>如果主机挂了，哨兵会自动投票选举出新的主机。</p>
<p>哨兵日志</p>
<p><img src="/myBlog/Redis/image-20211110204544847-1636731465019.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110204544847"></p>
</li>
</ol>
<p>如果主机再次恢复过来，也只能是归并到新的主机下，当做从机，这就是哨兵模式的规则。</p>
<p><strong>哨兵模式</strong></p>
<p>优点：</p>
<ol>
<li>哨兵集群，基于主从复制模式，所有的主从配置优点，他全有。</li>
<li>主从可以切换，故障可以转移，系统的可用性就会更好。</li>
<li>哨兵模式就是主从模式的升级，手动到自动，更加健壮。</li>
</ol>
<p>缺点：</p>
<ol>
<li>Redis不好在线扩容，集群容量一旦到达上限，在线扩容级十分麻烦。</li>
<li>实现哨兵模式的配置其实是很麻烦的，里面有很多选择。</li>
</ol>
<p><strong>哨兵模式的全部配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Example sentinel.conf  </span><br>  <br><span class="hljs-comment"># 哨兵sentinel实例运行的端口 默认26379  </span><br>port 26379  <br>  <br><span class="hljs-comment"># 哨兵sentinel的工作目录  </span><br>dir /tmp  <br>  <br><span class="hljs-comment"># 哨兵sentinel监控的redis主节点的 ip port   </span><br><span class="hljs-comment"># master-name  可以自己命名的主节点名字 只能由字母A-z、数字0-9 、这三个字符&quot;.-_&quot;组成。  </span><br><span class="hljs-comment"># quorum 当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了  </span><br><span class="hljs-comment"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;  </span><br>  sentinel monitor mymaster 127.0.0.1 6379 2  <br>  <br><span class="hljs-comment"># 当在Redis实例中开启了requirepass foobared 授权密码 这样所有连接Redis实例的客户端都要提供密码  </span><br><span class="hljs-comment"># 设置哨兵sentinel 连接主从的密码 注意必须为主从设置一样的验证密码  </span><br><span class="hljs-comment"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;  </span><br>sentinel auth-pass mymaster MySUPER--secret-0123passw0rd  <br>  <br>  <br><span class="hljs-comment"># 指定多少毫秒之后 主节点没有应答哨兵sentinel 此时 哨兵主观上认为主节点下线 默认30秒  </span><br><span class="hljs-comment"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;  </span><br>sentinel down-after-milliseconds mymaster 30000  <br>  <br><span class="hljs-comment"># 这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，  </span><br>这个数字越小，完成failover所需的时间就越长，  <br>但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。  <br>可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。  <br><span class="hljs-comment"># sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;  </span><br>sentinel parallel-syncs mymaster 1  <br>  <br>  <br>  <br><span class="hljs-comment"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面：   </span><br><span class="hljs-comment">#1. 同一个sentinel对同一个master两次failover之间的间隔时间。  </span><br><span class="hljs-comment">#2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。  </span><br><span class="hljs-comment">#3.当想要取消一个正在进行的failover所需要的时间。    </span><br><span class="hljs-comment">#4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了  </span><br><span class="hljs-comment"># 默认三分钟  </span><br><span class="hljs-comment"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;  </span><br>sentinel failover-timeout mymaster 180000  <br>  <br><span class="hljs-comment"># SCRIPTS EXECUTION  </span><br>  <br><span class="hljs-comment">#配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。  </span><br><span class="hljs-comment">#对于脚本的运行结果有以下规则：  </span><br><span class="hljs-comment">#若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10  </span><br><span class="hljs-comment">#若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。  </span><br><span class="hljs-comment">#如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。  </span><br><span class="hljs-comment">#一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。  </span><br>  <br><span class="hljs-comment">#通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，  </span><br>这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，  <br>一个是事件的类型，  <br>一个是事件的描述。  <br>如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。  <br><span class="hljs-comment">#通知脚本  </span><br><span class="hljs-comment"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;  </span><br>  sentinel notification-script mymaster /var/redis/notify.sh  <br>  <br><span class="hljs-comment"># 客户端重新配置主节点参数脚本  </span><br><span class="hljs-comment"># 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。  </span><br><span class="hljs-comment"># 以下参数将会在调用脚本时传给脚本:  </span><br><span class="hljs-comment"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;  </span><br><span class="hljs-comment"># 目前&lt;state&gt;总是“failover”,  </span><br><span class="hljs-comment"># &lt;role&gt;是“leader”或者“observer”中的一个。   </span><br><span class="hljs-comment"># 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的  </span><br><span class="hljs-comment"># 这个脚本应该是通用的，能被多次调用，不是针对性的。  </span><br><span class="hljs-comment"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;  </span><br> sentinel client-reconfig-script mymaster /var/redis/reconfig.sh<br></code></pre></td></tr></table></figure>



<h1 id="Redis缓存穿透、击穿和雪崩"><a href="#Redis缓存穿透、击穿和雪崩" class="headerlink" title="Redis缓存穿透、击穿和雪崩"></a>Redis缓存穿透、击穿和雪崩</h1><p>面试高频，工作常用。服务的高可用问题。</p>
<p>Redis缓存的使用，极大的提升了应用程序的性能和效率，特别是数据查询方面。但同时，他也带来了一些问题。其中，最要害的问题，就是数据的一致性问题，从严格意义上讲，这个问题无解。如果对数据的一致性要求很高，那么就不能使用缓存。</p>
<p>另外的一些典型问题就是，缓存穿透、缓存雪崩和缓存击穿。目录，业界也都有比较流行的解决方案。</p>
<p><img src="/myBlog/Redis/image-20211110212837552-1636731483147.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110212837552"></p>
<h2 id="缓存穿透（查不到）"><a href="#缓存穿透（查不到）" class="headerlink" title="缓存穿透（查不到）"></a>缓存穿透（查不到）</h2><p><strong>概念</strong></p>
<p>缓存穿透的概念很简单，用户想要查询一个数据，发现redis内存数据库中没有，也就是缓存没有命中，于是向持久层数据库查询。发现也没有，本次查询失败。当用户很多的时候，缓存都没有命中（秒杀），都去请求了持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当于缓存穿透。</p>
<p><strong>布隆过滤器</strong></p>
<p>布隆过滤器是一种数据结构，对所有可能查询的参数以hash形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的查询压力；</p>
<p><img src="/myBlog/Redis/image-20211110214237579-1636731483147.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110214237579"></p>
<p><strong>缓存空对象</strong></p>
<p>当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据将会从缓存中获取，保护了后端数据源。</p>
<p><img src="/myBlog/Redis/image-20211110214533317-1636731483148.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110214533317"></p>
<p>但是这种方法会存在两个问题：</p>
<ol>
<li>如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空值的键；</li>
<li>即使对空值设置了过期时间，还是会存在缓冲层和存储层的数据会有一段时间窗口的不一致，这对于需要保存一致性的业务会有影响。</li>
</ol>
<h2 id="缓存击穿（量太大，缓存过期）"><a href="#缓存击穿（量太大，缓存过期）" class="headerlink" title="缓存击穿（量太大，缓存过期）"></a>缓存击穿（量太大，缓存过期）</h2><p><strong>概述</strong></p>
<p>这里需要注意和缓存穿透的区别，缓存击穿是指一个key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个key在失效的瞬间，持续的大并发级穿透缓存，直接请求数据库，就像在一个屏幕上凿开了一个洞。</p>
<p>当某个key在过期瞬间，有大量的请求并发访问，这类数据一般都是热点数据，由于缓存过期，会同时访问数据库来查询最新数据，并且回写缓存，会导致数据库瞬间压力过大。</p>
<p><strong>解决方案</strong></p>
<p><strong>设置热点数据永不过期</strong></p>
<p>从缓存层面来看，没有设置过期时间，所以不会出现热点key过期后产生的问题。</p>
<p><strong>加互斥锁</strong></p>
<p>分布式锁：使用分布式锁，保证对于每个key同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到分布式锁，因此对分布式锁的考验很大。</p>
<p><img src="/myBlog/Redis/image-20211110220805289-1636731483148.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110220805289"></p>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><p><strong>概念</strong></p>
<p>缓存雪崩，是指在某一个时间段，缓存集中过期失效。Redis宕机！</p>
<p>产生雪崩的原因之一，比如双十一零点抢购，这波商品时间比较集中的放入了缓存，假设缓存一个小时。那么到凌晨一点的时候，这批商品的缓存就过期了。而这批商品的访问查询，都落到了数据库上，对于数据库而言，就会产生周期性的压力波峰。于是所有的请求都会达到存储层，存储层的调用会暴增，造成存储层也会挂掉的情况。</p>
<p><img src="/myBlog/Redis/image-20211110221746510-1636731483148.png" srcset="/myBlog/img/loading.gif" lazyload alt="image-20211110221746510"></p>
<p>其实集中过期倒不是非常致命，比较致命的缓存雪崩是缓存服务器某个节点宕机或者断网。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，这个时候数据库也是可以顶住压力的。无非就是对数据库产生周期性的压力而已。而缓存服务节点的宕机，对数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮。</p>
<p><strong>解决方案</strong></p>
<p><strong>redis高可用</strong></p>
<p>这个思想的含义是，既然redis有可能挂掉，那我就多增设几台redis，这样一台挂掉之后其他的还可以继续工作，其实就是搭建的集群（异地多活）。</p>
<p><strong>限流降级</strong></p>
<p>这个解决方案的思想就是在缓存失效后，通过加锁或者队列来控制读数据库缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。</p>
<p><strong>数据预热</strong></p>
<p>数据预热的含义就是在正式部署之前，先把可能的数据预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的key，设置不同的过期时间，让缓存失效的时间尽量均匀。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/myBlog/categories/Database/">Database</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/myBlog/tags/Redis/">Redis</a>
                    
                      <a class="hover-with-bg" href="/myBlog/tags/NoSQL/">NoSQL</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/myBlog/SpringMVC/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SpringMVC</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/myBlog/Linux/">
                        <span class="hidden-mobile">Linux</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://github.com" target="_blank" rel="nofollow noopener"><span>GitHub</span></a> <i class="iconfont icon-love"></i> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
  
  <div>
      <span id="timeDate">载入天数...</span>
      <span id="times">载入时分秒...</span>
      <script>
      var now = new Date();
      function createtime(){
          var grt= new Date("11/11/2021 00:00:00");//此处修改你的建站时间或者网站上线时间
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24;
          dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
          hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){
              hnum = "0" + hnum;
          }
          minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes);
          if(String(mnum).length ==1 ){
                    mnum = "0" + mnum;
          }
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds);
          if(String(snum).length ==1 ){
                    snum = "0" + snum;
          }
          document.getElementById("timeDate").innerHTML = "本站安全运行&nbsp"+dnum+"&nbsp天";
          document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
      }
      setInterval("createtime()",250);
      </script>
    </div>
  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/myBlog/js/events.js" ></script>
<script  src="/myBlog/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/myBlog/js/local-search.js" ></script>



  
    <script  src="/myBlog/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/myBlog/js/boot.js" ></script>


</body>
</html>
